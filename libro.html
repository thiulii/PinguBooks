<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalle del libro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles/styles.css" />
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="./media/logo.png" alt="" height="40" />
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">

          <li class="nav-item">
            <a class="nav-link" href="index.html">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-house-door" viewBox="0 0 16 16">
                <path
                  d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4z" />
              </svg>Inicio
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="catalogo.html">Cat√°logo</a>
          </li>

          <li class="nav-item me-2">
            <a class="nav-link" href="perfil_autor.html" id="miPerfil">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-person" viewBox="0 0 16 16">
                <path
                  d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z" />
              </svg>Perfil
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="write.html">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-house-door" viewBox="0 0 16 16">
                <path
                  d="M8.5 2.687c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783" />
              </svg>Escritura
            </a>
          </li>

        </ul>

        <form class="d-flex align-items-center me-3" role="search">
          <input class="form-control me-2" type="search" placeholder="Search" aria-label="Buscar" />
          <button class="btn btn-outline-success" type="submit">Buscar</button>
        </form>

        <div class="d-flex align-items-center">
          <a class="btn btn-outline-success ms-3" href="iniciar_sesion.html">
            <span id="sesion">Iniciar sesi√≥n</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- la pagina se mostrara a usaurios logueados como no logueados, la diferencia se hara en los permisos de edicion o agregar comentarios -->
  
  <div class="container perfil-container mt-4">
    <div class="row">
      <div class="col-md-4 text-center">
        <img id="portada" src="" alt="Portada" class="img-fluid rounded mb-3" />
      </div>
      <div class="col-md-8">
        <h1 id="titulo"></h1>
        <p><strong>Autor: </strong> <a href="#" id="linkAutor"></a></p>
        <p><strong>Resumen: </strong> <span id="descripcion"></span></p>
        <p><strong>Publicado el: </strong> <span id="fechaPublicacion"></span></p>
        <p><strong>Puntuaci√≥n: </strong> <span id="puntuacion"></span>/5 ‚≠ê</p>
        <p><strong>Tags: </strong> <span id="tagsContainer"></span></p>
      </div>

      <div class="contenedor-lectura mt-3">
        <div id="contenido" class="contenido-libro"></div>
        <button id="expandir" class="btn btn-sm btn-outline-primary mt-2">üìñ Expandir lectura</button>
        <button id="cerrarLectura" class="btn btn-sm btn-outline-danger cerrar-lectura" style="display: none;">‚ùå Cerrar</button>
      </div>

        <!-- si la persona esta logueada y es el autor, puede editar la obra -->
        <section id="editarObraSection" style="display:none;">
          <h5>Editar Obra</h5>
          <form id="editarObraForm">
            <div class="mb-2">
              <input type="text" id="editarTitulo" class="form-control" required />
            </div>
            <div class="mb-2">
              <input type="url" id="editarPortada" class="form-control" placeholder="URL portada" />
            </div>
            <div class="mb-2">
              <textarea id="editarDescripcion" class="form-control" rows="2" required></textarea>
            </div>
            <div class="mb-2">
              <textarea id="editarContenido" class="form-control" rows="6" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
          </form>
        </section>

        <!-- obra -->
        <hr>
        <h5>Leer Obra</h5>
        <div id="contenido" class="contenido-libro">
        </div>
      </div>
    </div>

    <!-- comentarios -->
    <hr class="my-4">
    <h5>Comentarios</h5>
    <div id="comentariosContainer"></div>

    <!-- usuario logueado puede agregar comentarios a la obra -->
    <section id="agregarComentarioSection" style="display:none;">
      <h5>Agregar comentario</h5>
      <form id="agregarComentarioForm">
        <div class="mb-2">
          <input type="number" id="estrellas" class="form-control" min="0" max="5" value="5" required placeholder="0-5 estrellas" />
        </div>
        <div class="mb-2">
          <textarea id="nuevoComentario" class="form-control" rows="3" placeholder="Tu comentario..." required></textarea>
        </div>
        <button type="submit" class="btn btn-success">Enviar</button>
      </form>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>

  <script>

    // mejoro la lectura para que la casilla se expanda
    const botonExpandir = document.getElementById('expandir');
    const contenedor = document.getElementById('contenido');
    const botonCerrar = document.getElementById('cerrarLectura');

    botonExpandir.addEventListener('click', () => {
      contenedor.classList.add('expandido');
      botonCerrar.style.display = 'block';
      botonExpandir.style.display = 'none';
    });

    botonCerrar.addEventListener('click', () => {
      contenedor.classList.remove('expandido');
      botonCerrar.style.display = 'none';
      botonExpandir.style.display = 'inline-block';
    });

    const UrlApi = "http://localhost:3000";
    
    const params = new URLSearchParams(window.location.search);
    const idObra = params.get("id");
    const idUsuario = Number(localStorage.getItem("idUsuario")); 

    const portadaEl = document.getElementById("portada");                               // contenido general
    const tituloEl = document.getElementById("titulo");
    const linkAutorEl = document.getElementById("linkAutor");
    const descripcionEl = document.getElementById("descripcion");
    const contenidoEl = document.getElementById("contenido");
    const fechaPublicacionEl = document.getElementById("fechaPublicacion");
    const puntuacionEl = document.getElementById("puntuacion");
    const tagsContainerEl = document.getElementById("tagsContainer");


    const editarSeccion = document.getElementById("editarObraSection");                 // exclusivo autor
    const editarForm = document.getElementById("editarObraForm");
    const editTitulo = document.getElementById("editarTitulo");
    const editPortada = document.getElementById("editarPortada");
    const editDesc = document.getElementById("editarDescripcion");
    const editCont = document.getElementById("editarContenido");

    const comentariosContainer = document.getElementById("comentariosContainer");       // exclusivo logueado
    const agregarSeccion = document.getElementById("agregarComentarioSection");
    const agregarForm = document.getElementById("agregarComentarioForm");
    const inputEstrellas = document.getElementById("estrellas");
    const inputComentario = document.getElementById("nuevoComentario");

    let obraData, comentarios = [];

    async function cargarLibro() {
      const res = await fetch(`${UrlApi}/obras/${idObra}`);
      if (!res.ok) return alert("Error cargando obra");
      obraData = await res.json();
      portadaEl.src = obraData.portada;
      tituloEl.textContent = obraData.titulo;
      descripcionEl.textContent = obraData.descripcion;
      contenidoEl.innerHTML = obraData.contenido.replace(/\n/g, "<br>");
      fechaPublicacionEl.textContent = obraData.fecha_de_publicacion.split("T")[0];
      puntuacionEl.textContent = obraData.puntuacion?.toFixed(1) ?? "0.0";

      // cragar tags
      const resTags = await fetch(`${UrlApi}/tags`);
      if (resTags.ok) {
        const allTags = await resTags.json();
        const resRelacion = await fetch(`${UrlApi}/obras/${idObra}`);
        const obraCompleta = await resRelacion.json();
        const tagsObra = obraCompleta.tags || [];
        const tagsHTML = tagsObra.map(tag =>
          `<span class="badge bg-secondary me-1">${tag}</span>`
        ).join("");
        tagsContainerEl.innerHTML = tagsHTML;
      }

      // cargar autor
      const autorRes = await fetch(`${UrlApi}/autores/${obraData.id_autor}`);
      const autor = (await autorRes.json());
      linkAutorEl.textContent = autor.nombre;
      linkAutorEl.href = `perfil_autor.html?id=${autor.id_autor}`;

      // si es el autor, permito editar
      if (idUsuario === obraData.id_autor) {
        editarSeccion.style.display = "block";
        editTitulo.value = obraData.titulo;
        editPortada.value = obraData.portada;
        editDesc.value = obraData.descripcion;
        editCont.value = obraData.contenido;
      }
    }

    async function cargarComentarios() {
      const res = await fetch(`${UrlApi}/comentarios/${idObra}`);
      if (!res.ok) return console.error("Error al cargar comentarios");
      comentarios = await res.json();

      comentariosContainer.innerHTML = "";
      for (const c of comentarios) {
        // traigo los datos de la tabla de autor
        let autor = { nombre: "Desconocido", foto_perfil: "" };
        try {
          const autorRes = await fetch(`${UrlApi}/autores/${c.id_usuario}`);
          if (autorRes.ok) autor = await autorRes.json();
        } catch (err) {
          console.error("Error al traer autor:", err);
        }

        const div = document.createElement("div");
        div.className = "perfil-container mb-3"; // usa fondo blanco, borde redondo, padding

        div.innerHTML = `
          <div class="d-flex align-items-start gap-3">
            <img src="${autor.foto_perfil || './media/default-user.png'}" alt="Perfil" width="50" height="50" class="rounded-circle mt-1" />
            <div>
              <p class="mb-1">
                <a href="perfil_autor.html?id=${c.id_usuario}" class="fw-bold text-decoration-none">@${autor.nombre}</a>
                <small class="text-muted"> ‚Äì ${c.fecha_de_publicacion.split("T")[0]}</small>
              </p>
              <p class="mb-1">${c.contenido_comentario || "(sin contenido)"}</p>
              <p class="mb-2">${c.estrellas}/5 ‚≠ê</p>
            </div>
          </div>
        `;

        // si el usuario es el propietario del comentario muestro el bot√≥n de editar
        if (idUsuario == c.id_usuario) {
          const btn = document.createElement("button");
          btn.textContent = "Editar";
          btn.className = "btn btn-sm btn-outline-primary ms-2";
          btn.onclick = () => editarComentario(c);
          div.querySelector("div").appendChild(btn);
        }
        comentariosContainer.appendChild(div);
      }
      // si el usuario est√° logueado muestro secci√≥n de agregar comentario
      if (idUsuario) agregarSeccion.style.display = "block";
    }

    async function editarComentario(comm) {
      const newText = prompt("Modificar comentario:", comm.contenido_comentario);
      if (!newText) return;
      const newStars = prompt("Modificar puntuaci√≥n:", comm.estrellas);
      if (newStars === null || isNaN(newStars) || newStars < 0 || newStars > 5) return alert("Puntuaci√≥n inv√°lida");
      await fetch(`${UrlApi}/comentarios/${comm.id_comentarios}`, {
        method: "PUT",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({id_usuario: idUsuario, contenido: newText, estrellas: Number(newStars)})
      });
      cargarComentarios();
    }

    // modificar los datos de la obra (se ejecuta cuando se submitea el formulario que cambia los datos de la obra)
    editarForm.onsubmit = async e => {
      e.preventDefault();
      await fetch(`${UrlApi}/obras/${idObra}`, {
        method: "PUT",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({                       // arma JSON con los valores actualizados de la obra y se modifican
          titulo: editTitulo.value,
          portada: editPortada.value,
          descripcion: editDesc.value,
          contenido: editCont.value
        })
      });
      alert("Obra actualizada");
      cargarLibro();
    }
    
    // modificar los datos del comentario (se ejecuta cuando se submitea el formulario de los comentarios)
    agregarForm.onsubmit = async e => {
      e.preventDefault();
      await fetch(`${UrlApi}/comentarios`, {
        method: "POST",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({                       // arma JSON con los valores actualizados del comentario y se modifican
          id_usuario: idUsuario,
          id_obra: Number(idObra),
          estrellas: Number(inputEstrellas.value),
          contenido: inputComentario.value
        })
      });
      inputComentario.value = "";
      cargarComentarios();
    }

    cargarLibro();
    cargarComentarios();

  </script>
</body>
</html>
